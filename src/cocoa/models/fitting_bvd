import sys
import os
from functools import partial
import pandas as pd
import matplotlib.pyplot as plt

# Add the project's 'src' directory to the Python path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..')))

from cocoa.experiments.runner import ExperimentRunner
from cocoa.models import NPRegimeModel, GaussianKernel, LocalPolynomialEngine
from .assets import (
    PROCESSED_DATA_PATH,
    OOS_START_DATE,
    DEFAULT_FEATURE_COLS,  # Using same features as RF/XGB for comparability
    DEFAULT_TARGET_COL,
    Break_ID_ONE_BASED,
)


if __name__ == "__main__":
    # The NPRegimeModel requires kernel and local_engine objects at initialization.
    # The ExperimentRunner's grid search only passes hyperparameters from the grid.
    # To solve this, we use functools.partial to create a new "constructor"
    # that has the kernel and engine pre-filled.
    
    # 1. Define the core components for this NP model experiment
    kernel = GaussianKernel()
    engine = LocalPolynomialEngine(order=1) # Local Linear

    # 2. Create a partial constructor for the ExperimentRunner to use
    NPModelPartial = partial(NPRegimeModel, kernel=kernel, local_engine=engine)

    results = []

    # 3. Configure and run the Non-Parametric experiment in a loop
    for trimmed_date in range(0, 6736, 200):
        model_name = f"NP_LL_Post_Trim_{trimmed_date}"
        print(f"\n--- Running experiment for trimmed_date: {trimmed_date} ---")
        np_experiment = ExperimentRunner(
            model_name=model_name,
            model_class=NPModelPartial,
            feature_cols=DEFAULT_FEATURE_COLS,
            target_col=DEFAULT_TARGET_COL,
            data_path=PROCESSED_DATA_PATH,
            oos_start_date=OOS_START_DATE,
            kernel_name=kernel.__class__.__name__,
            poly_order=engine.order,
            sample_start_index=trimmed_date,
        )
        mse, bias_sq, variance, start_date = np_experiment.run_BVD_only()
        results.append({
            "start_date": start_date,
            "mse": mse,
            "bias_sq": bias_sq,
            "variance": variance,
        })

    # 4. Convert results to a DataFrame and plot
    results_df = pd.DataFrame(results).sort_values("start_date")

    plt.style.use("seaborn-v0_8-whitegrid")
    fig, ax = plt.subplots(figsize=(15, 8))

    ax.plot(results_df["start_date"], results_df["mse"], label="MSE (from BVD)", marker='o', linestyle='-')
    ax.plot(results_df["start_date"], results_df["bias_sq"], label="Bias^2", marker='s', linestyle='--')
    ax.plot(results_df["start_date"], results_df["variance"], label="Variance", marker='^', linestyle=':')

    ax.set_title("Bias-Variance Decomposition vs. Training Start Date", fontsize=16)
    ax.set_xlabel("Training Set Start Date", fontsize=12)
    ax.set_ylabel("Error Component Value", fontsize=12)
    ax.legend(fontsize=10)
    ax.tick_params(axis='x', rotation=45)

    plt.savefig("w:/Research/NP/Cocoa/output/bvd_vs_time.png", bbox_inches="tight")
    print("\nPlot of BVD components vs. start date saved to w:/Research/NP/Cocoa/output/bvd_vs_time.png")
